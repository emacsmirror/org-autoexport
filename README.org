#+title: Org Autoexport
#+author: Glenn Hutchings
#+email: zondo42@gmail.com

#+auto_export: gfm
#+auto_export: html

* Intro

TODO: write intro

* Plan

Write a more general org auto-exporter:

- Add save hook to possibly export org file
- Export automatically or only if exported suffix already exists
- Ignore narrowing and region settings on export

* Ideas

Move development into this file, tangled to the output.

Use ~org-export-to-file~ for the export.  Can specify backend as a symbol:

#+begin_src elisp :eval no
  (org-export-to-file 'md "README.md")
  (org-export-to-file 'html "README.html")

  ;; This determines whether the backend exists.
  (org-export-get-backend 'gfm) ;; yes
  (org-export-get-backend 'md) ;; yes
  (org-export-get-backend 'nope) ;; no
#+end_src

Think this handles narrowing and region as well.  Needs testing.

Use the same configuration method as [[https://github.com/yilkalargaw/org-auto-tangle][org-auto-tangle]]:

#+begin_src org :eval no
  ,#+auto_export: gfm
  ,#+auto_export: html
#+end_src

Using ~org-collect-keywords~ to get the values here:

#+name: get-export-backends
#+begin_src elisp :results verbatim :results silent
  (defun org-autoexport-get-export-backends ()
    "Get the list of backends to auto-export.

  This is the list of backend names declared by #+auto_export:
  keywords in the org file."
    (delete "AUTO_EXPORT" (car (org-collect-keywords '("AUTO_EXPORT")))))
#+end_src

#+begin_src elisp :results verbatim
  (org-autoexport-get-export-backends)
#+end_src

#+RESULTS:
: ("gfm" "html")

Need a way to map the backend to suffix.  Have override alist.

#+begin_src elisp :results silent
  (defconst org-autoexport-backend-suffix-map
    '(("gfm" . "md"))
    "Mapping of backend name to file suffix, for special cases where they are different.")
#+end_src

Default is to use the backend name:

#+name: get-export-suffix
#+begin_src elisp :results silent
  (defun org-autoexport-get-export-suffix (backend)
    "Return the file suffix used to autoexport using BACKEND (a string).

  Default is the name of the backend itself, unless a special case
  is found in `org-autoexport-backend-suffix-map'."
    (alist-get backend org-autoexport-backend-suffix-map backend nil 'equal))
#+end_src

#+begin_src elisp
  (let ((output "")
        (suffix))
    (dolist (backend (org-autoexport-get-export-backends) output)
      (setq suffix (org-autoexport-get-export-suffix backend))
      (setq output (concat output (format "Backend '%s' -> '%s'\n" backend suffix)))))
#+end_src

#+RESULTS:
: Backend 'gfm' -> 'md'
: Backend 'html' -> 'html'

And then to check there's a backend defined with this symbol:

#+name: get-backend
#+begin_src elisp :results silent
  (defun org-autoexport-get-backend (backend)
    "Return the file suffix used to autoexport using BACKEND."
    (org-export-get-backend (intern backend)))
#+end_src

#+begin_src elisp
  (if (org-autoexport-get-backend "gfm")
      (message "Backend found")
    (message "Backend not found"))
#+end_src

#+RESULTS:
: Backend found

* Original code

#+begin_src elisp
  (defun my-export-markdown-on-save ()
    "Export Org file to markdown if the markdown file already exists."

    (let* ((pathname (buffer-file-name))
           (markdown (replace-regexp-in-string "\\.org$" ".md" pathname)))
      (when (and (s-suffix-p ".org" pathname) (f-exists-p markdown))
        (org-gfm-export-to-markdown nil nil nil))))

  (add-hook 'after-save-hook 'my-export-markdown-on-save)
#+end_src
